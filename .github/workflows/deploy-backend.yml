name: deploy
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: SSH deploy
        uses: appleboy/ssh-action@v1
        with:
          host:     ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key:      ${{ secrets.EC2_SSH_KEY }}   # EC2 접속용 PEM 키
          script: |
            set -e
            sudo dnf -y install git

            # GitHub 접근용 SSH 키 설정 (Deploy Key의 개인키)
            mkdir -p ~/.ssh
            echo "${{ secrets.EC2_GIT_KEY }}" | tee ~/.ssh/id_rsa > /dev/null
            chmod 600 ~/.ssh/id_rsa

            # GitHub 호스트 인증 스킵 (보안 신경 쓸 경우 직접 검증 권장)
            ssh-keyscan github.com >> ~/.ssh/known_hosts

            # 레포지토리 클론 또는 pull
            REPO_DIR=/home/${{ secrets.EC2_USER }}/Arrange
            if [ ! -d "$REPO_DIR/.git" ]; then
              git clone git@github.com:seojaeohcode/Arrange.git "$REPO_DIR"
            else
              cd "$REPO_DIR"
              git pull
            fi

# name: deploy
# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4

#       - name: SSH deploy
#         uses: appleboy/ssh-action@v1
#         with:
#           host:     ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key:      ${{ secrets.EC2_SSH_KEY }}   # EC2 접속용 PEM 키
#           script: |
#             set -e
#             sudo dnf -y install git

#             # GitHub 접근용 SSH 키 설정 (Deploy Key의 개인키)
#             mkdir -p ~/.ssh
#             echo "${{ secrets.EC2_GIT_KEY }}" | tee ~/.ssh/id_rsa > /dev/null
#             chmod 600 ~/.ssh/id_rsa

#             # GitHub 호스트 인증 스킵 (보안 신경 쓸 경우 직접 검증하세요)
#             ssh-keyscan github.com >> ~/.ssh/known_hosts

#             REPO_DIR=/home/${{ secrets.EC2_USER }}/Arrange
#             if [ ! -d "$REPO_DIR/.git" ]; then
#               git clone git@github.com:seojaeohcode/Arrange.git "$REPO_DIR"
#             fi
#             cd "$REPO_DIR"
#             git pull

#             BACKEND=$REPO_DIR/backend
#             if [ ! -d "$BACKEND/venv" ]; then
#               python3 -m venv "$BACKEND/venv"
#             fi
#             source "$BACKEND/venv/bin/activate"
#             pip install -r "$BACKEND/requirements.txt"

#             pkill -f "uvicorn app.main:app" || true
#             cd "$BACKEND"
#             nohup ./venv/bin/uvicorn app.main:app \
#                   --host 0.0.0.0 --port 8000 --reload \
#                   > ../uvicorn.out 2>&1 &

# name: Deploy to EC2

# on:
#   push:
#     branches: [ main ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout
#       uses: actions/checkout@v2

#     - name: Set up Python
#       uses: actions/setup-python@v2
#       with:
#         python-version: "3.10"

#     - name: Install deps
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r backend/requirements.txt

#     # ① 코드 업로드 (scp/rsync 전용 액션 사용 -- SSH 한 번)
#     - name: Copy backend to EC2
#       uses: appleboy/scp-action@v0.1.1
#       with:
#         host: ${{ secrets.EC2_HOST }}
#         username: ${{ secrets.EC2_USER }}          
#         key: ${{ secrets.EC2_SSH_KEY }}
#         source: "backend/"
#         target: "/home/${{ secrets.EC2_USER }}/myproject/backend"

#     # ② 원격 실행 (ssh-action -- 두 번째 SSH)
#     - name: Remote deploy commands
#       uses: appleboy/ssh-action@v0.1.2
#       with:
#         host: ${{ secrets.EC2_HOST }}
#         username: ${{ secrets.EC2_USER }}         
#         key: ${{ secrets.EC2_SSH_KEY }}
#         script: |
#           PROJECT_DIR=/home/${{ secrets.EC2_USER }}/myproject/backend
#           cd $PROJECT_DIR
#           # 이미 떠 있는 프로세스가 있다면 종료(선택)
#           pkill -f "uvicorn app.main:app" || true
#           # 새로 실행
#           nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload > uvicorn.out 2>&1 &
